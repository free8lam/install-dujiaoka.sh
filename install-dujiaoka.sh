#!/bin/bash
set -e

echo "=== ç‹¬è§’æ•°è‡ªåŠ¨å‘å¡ç³»ç»Ÿ 2.0.6-antibody ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆç¨³å®šä¿®å¤ç‰ˆï¼‰==="

# ç”¨æˆ·äº¤äº’è¾“å…¥
read -p "è¯·è¾“å…¥ç½‘ç«™åŸŸåï¼ˆï¼‰: " DOMAIN
read -p "è¯·è¾“å…¥ç”¨äºç”³è¯· SSL çš„é‚®ç®±: " SSL_EMAIL
read -p "è¯·è¾“å…¥ MySQL root å¯†ç ï¼ˆæ— å¯†ç ç›´æ¥å›è½¦ï¼‰: " MYSQL_ROOT_PASS
read -p "è¯·è¾“å…¥ç‹¬è§’æ•°æ•°æ®åº“åï¼ˆé»˜è®¤ dujiaokaï¼‰: " DB_NAME
DB_NAME=${DB_NAME:-dujiaoka}
read -p "è¯·è¾“å…¥ç‹¬è§’æ•°æ•°æ®åº“ç”¨æˆ·åï¼ˆé»˜è®¤ dujiaokaï¼‰: " DB_USER
DB_USER=${DB_USER:-dujiaoka}
read -p "è¯·è¾“å…¥ç‹¬è§’æ•°æ•°æ®åº“ç”¨æˆ·å¯†ç : " DB_PASS

INSTALL_DIR="/var/www/dujiaoka"
PHP_VER="8.3"
DUJIAOKA_VER="2.0.6-antibody"
DOWNLOAD_URL="https://github.com/assimon/dujiaoka/releases/download/2.0.6/2.0.6-antibody.tar.gz"

# æ˜¾ç¤ºç¡®è®¤
echo ""
echo "===== é…ç½®ä¿¡æ¯ç¡®è®¤ ====="
echo "åŸŸå: $DOMAIN"
echo "SSLé‚®ç®±: $SSL_EMAIL"
echo "æ•°æ®åº“å: $DB_NAME"
echo "æ•°æ®åº“ç”¨æˆ·: $DB_USER"
echo "æ•°æ®åº“å¯†ç : (å·²éšè—)"
echo "å®‰è£…ç›®å½•: $INSTALL_DIR"
echo "PHPç‰ˆæœ¬: $PHP_VER"
echo ""

# å®‰è£…ç¯å¢ƒ
apt update && apt upgrade -y
apt install -y nginx mysql-server curl wget unzip git certbot python3-certbot-nginx \
    php${PHP_VER}-fpm php-mysql php-curl php-gd php-intl php-mbstring php-soap \
    php-xml php-zip php-bcmath php-cli php-common php-tokenizer

# MySQL é…ç½®
echo "é…ç½® MySQL æ•°æ®åº“..."
if [ -z "$MYSQL_ROOT_PASS" ]; then
  MYSQL_CMD="mysql"
else
  MYSQL_CMD="mysql -uroot -p${MYSQL_ROOT_PASS}"
  echo "SELECT 1;" | $MYSQL_CMD >/dev/null 2>&1 || { echo "MySQL rootå¯†ç é”™è¯¯"; exit 1; }
fi

$MYSQL_CMD <<EOF
CREATE DATABASE IF NOT EXISTS \`${DB_NAME}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';
GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'localhost';
FLUSH PRIVILEGES;
EOF

# ä¸‹è½½ç‹¬è§’æ•°
echo "ä¸‹è½½ç‹¬è§’æ•°ç¨‹åº..."
mkdir -p $INSTALL_DIR
cd /tmp
curl -L -o dujiaoka.tar.gz -H "User-Agent: Mozilla/5.0" "$DOWNLOAD_URL"
tar -zxf dujiaoka.tar.gz
cp -r dujiaoka/* $INSTALL_DIR

# æƒé™è®¾ç½®
chown -R www-data:www-data $INSTALL_DIR
find $INSTALL_DIR -type d -exec chmod 755 {} \;
find $INSTALL_DIR -type f -exec chmod 644 {} \;

# åˆ›å»º Laravel .env
echo "ç”Ÿæˆ Laravel é…ç½®æ–‡ä»¶..."
cp $INSTALL_DIR/.env.example $INSTALL_DIR/.env
sed -i "s/DB_DATABASE=.*/DB_DATABASE=${DB_NAME}/" $INSTALL_DIR/.env
sed -i "s/DB_USERNAME=.*/DB_USERNAME=${DB_USER}/" $INSTALL_DIR/.env
sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${DB_PASS}/" $INSTALL_DIR/.env

# é…ç½® nginx
echo "é…ç½® Nginx..."
cat >/etc/nginx/sites-available/$DOMAIN.conf <<EOF
server {
    listen 80;
    server_name $DOMAIN;

    root $INSTALL_DIR/public;
    index index.php index.html;

    location / {
        try_files \$uri \$uri/ /index.php?\$args;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php${PHP_VER}-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }

    location ~ /\.ht {
        deny all;
    }

    location ~ /.well-known/acme-challenge/ {
        allow all;
    }
}
EOF

ln -sf /etc/nginx/sites-available/$DOMAIN.conf /etc/nginx/sites-enabled/
nginx -t && systemctl reload nginx

# SSLç”³è¯·ï¼ˆIPv4æ¨¡å¼ï¼‰
echo "ç”³è¯· SSLï¼ˆIPv4 å¼ºåˆ¶ï¼‰..."
certbot --nginx -d $DOMAIN --non-interactive --agree-tos -m "$SSL_EMAIL" --preferred-challenges http --no-eff-email --force-renewal || {
    echo "SSLç”³è¯·å¤±è´¥ï¼Œå°†ç»§ç»­ä½¿ç”¨HTTP"
}

# æ›¿æ¢ä¸º HTTPS é…ç½®
if [ -f /etc/letsencrypt/live/$DOMAIN/fullchain.pem ]; then
    echo "åˆ‡æ¢ä¸º HTTPS é…ç½®..."
    cat >/etc/nginx/sites-available/$DOMAIN.conf <<EOF
server {
    listen 80;
    server_name $DOMAIN;
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl;
    server_name $DOMAIN;

    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    root $INSTALL_DIR/public;
    index index.php index.html;

    client_max_body_size 1024M;

    location / {
        try_files \$uri \$uri/ /index.php?\$args;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php${PHP_VER}-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }

    location ~ /\.ht {
        deny all;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf|eot)\$ {
        expires max;
        log_not_found off;
    }
}
EOF
    nginx -t && systemctl reload nginx
fi

# Laravel åˆå§‹åŒ–
echo "åˆå§‹åŒ– Laravel..."
cd $INSTALL_DIR
php artisan key:generate
php artisan config:cache
php artisan migrate --force

chown -R www-data:www-data $INSTALL_DIR

# PHP ä¼˜åŒ–
echo "ä¼˜åŒ– PHP å‚æ•°..."
INI_PATH="/etc/php/${PHP_VER}/fpm/php.ini"
sed -i "s/post_max_size = .*/post_max_size = 1024M/" $INI_PATH
sed -i "s/upload_max_filesize = .*/upload_max_filesize = 1024M/" $INI_PATH
sed -i "s/max_execution_time = .*/max_execution_time = 900/" $INI_PATH
sed -i "s/max_input_time = .*/max_input_time = 900/" $INI_PATH

systemctl restart php${PHP_VER}-fpm
systemctl restart nginx

echo ""
echo "âœ… å®‰è£…å®Œæˆï¼è¯·è®¿é—®ä»¥ä¸‹åœ°å€åˆå§‹åŒ–ç½‘ç«™ï¼š"
echo "ğŸ‘‰ https://$DOMAIN"
echo ""
